<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Printer Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.5;
            padding: 20px 15px 40px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e1e5eb;
        }
        
        h1 {
            font-size: 1.8rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h1 i {
            color: #3498db;
        }
        
        .status-badge {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            background-color: #e8f6f3;
            color: #27ae60;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-badge.offline {
            background-color: #fdedec;
            color: #e74c3c;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .action-btn:hover {
            background-color: #2980b9;
        }
        
        .action-btn:active {
            transform: scale(0.98);
        }
        
        .action-btn.add {
            background-color: #27ae60;
        }
        
        .action-btn.add:hover {
            background-color: #219653;
        }
        
        .action-btn.refresh {
            background-color: #7f8c8d;
        }
        
        .action-btn.refresh:hover {
            background-color: #6c7b7d;
        }
        
        .printer-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .printer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        }
        
        .printer-header {
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8fafc;
            border-bottom: 1px solid #eef2f7;
        }
        
        .printer-name-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .printer-icon {
            width: 44px;
            height: 44px;
            background-color: #3498db;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
        }
        
        .printer-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .printer-id {
            font-size: 0.9rem;
            color: #7f8c8d;
            font-family: monospace;
        }
        
        .printer-role {
            font-size: 0.85rem;
            padding: 4px 12px;
            background-color: #e8f4fc;
            color: #3498db;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .printer-role.admin {
            background-color: #fef9e7;
            color: #f39c12;
        }
        
        .printer-details {
            padding: 20px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: #7f8c8d;
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .detail-value {
            font-weight: 600;
            color: #2c3e50;
            text-align: right;
            font-family: monospace;
            max-width: 60%;
            word-break: break-word;
        }
        
        .connection-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .connection-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #27ae60;
            display: inline-block;
        }
        
        .connection-dot.offline {
            background-color: #e74c3c;
        }
        
        .paper-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .paper-width {
            font-size: 0.85rem;
            background-color: #f2f4f7;
            padding: 3px 8px;
            border-radius: 4px;
            color: #5d6d7e;
        }
        
        .settings-info {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }
        
        .setting-badge {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 6px;
            background-color: #f8f9fa;
            color: #5d6d7e;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid #eaecee;
        }
        
        .printer-actions {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background-color: #f9fbfd;
            border-top: 1px solid #eef2f7;
            justify-content: flex-end;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .btn-edit {
            background-color: #f8f9fa;
            color: #3498db;
            border: 1px solid #3498db;
        }
        
        .btn-edit:hover {
            background-color: #3498db;
            color: white;
        }
        
        .btn-test {
            background-color: #f8f9fa;
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        
        .btn-test:hover {
            background-color: #27ae60;
            color: white;
        }
        
        .btn-delete {
            background-color: #f8f9fa;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        .btn-delete:hover {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-toggle {
            background-color: #f8f9fa;
            color: #f39c12;
            border: 1px solid #f39c12;
        }
        
        .btn-toggle:hover {
            background-color: #f39c12;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn:disabled:hover {
            background-color: #f8f9fa;
            color: inherit;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal {
            background-color: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eef2f7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #95a5a6;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .modal-close:hover {
            background-color: #f5f7fa;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d8e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-checkbox input {
            width: 18px;
            height: 18px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eef2f7;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .loading-spinner {
            border: 3px solid rgba(52, 152, 219, 0.2);
            border-radius: 50%;
            border-top: 3px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #7f8c8d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #bdc3c7;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #5d6d7e;
        }
        
        footer {
            margin-top: 30px;
            text-align: center;
            color: #95a5a6;
            font-size: 0.85rem;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #2c3e50;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            animation: slideUp 0.3s ease-out;
        }
        
        .toast.success {
            background-color: #27ae60;
        }
        
        .toast.error {
            background-color: #e74c3c;
        }
        
        @keyframes slideUp {
            from { bottom: -50px; opacity: 0; }
            to { bottom: 20px; opacity: 1; }
        }
        
        .confirmation-modal .modal-body {
            text-align: center;
            padding: 30px 20px;
        }
        
        .confirmation-icon {
            font-size: 3rem;
            color: #e74c3c;
            margin-bottom: 15px;
        }
        
        .confirmation-text {
            margin-bottom: 20px;
            color: #5d6d7e;
            font-size: 1.1rem;
        }
        
        @media (max-width: 480px) {
            .printer-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .printer-role {
                align-self: flex-start;
            }
            
            .detail-row {
                flex-direction: column;
                gap: 5px;
            }
            
            .detail-value {
                text-align: left;
                max-width: 100%;
            }
            
            .settings-info {
                justify-content: flex-start;
            }
            
            .printer-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .header-actions {
                flex-wrap: wrap;
                justify-content: flex-end;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1><i class="fas fa-print"></i> Printer Manager</h1>
                <div class="status-badge">
                    <i class="fas fa-circle"></i>
                    <span id="statusText">Loading...</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="action-btn refresh" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i>
                    Refresh
                </button>
                <button class="action-btn add" id="addPrinterBtn">
                    <i class="fas fa-plus"></i>
                    Add Printer
                </button>
            </div>
        </header>
        
        <main id="printersContainer">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading printer data...</p>
            </div>
        </main>
        
        <footer>
            <p>Printer Management System • Connected to local network</p>
        </footer>
    </div>

    <!-- Printer Form Modal -->
    <div class="modal-overlay" id="printerModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Add Printer</div>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="printerForm">
                    <input type="hidden" id="printerId" value="">
                    
                    <div class="form-group">
                        <label class="form-label" for="printerName">Printer Name</label>
                        <input type="text" class="form-input" id="printerName" placeholder="e.g., Cash Counter 1" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="printerRole">Printer Role</label>
                        <select class="form-select" id="printerRole" required>
                            <option value="CASHIER">Cashier</option>
                            <option value="KITCHEN">Kitchen</option>
                            <option value="BAR">Bar</option>
                            <option value="ADMIN">Admin</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="printerIp">IP Address</label>
                            <input type="text" class="form-input" id="printerIp" placeholder="192.168.1.4" required pattern="^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="printerPort">Port</label>
                            <input type="number" class="form-input" id="printerPort" placeholder="9100" value="9100" required min="1" max="65535">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="paperName">Paper Type</label>
                            <input type="text" class="form-input" id="paperName" placeholder="RECEIPT(72mm)" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="paperWidth">Paper Width (px)</label>
                            <input type="number" class="form-input" id="paperWidth" placeholder="576" value="576" required min="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Print Settings</label>
                        <div class="form-checkbox">
                            <input type="checkbox" id="cutPaper" checked>
                            <label for="cutPaper">Auto Cut After Print</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="form-checkbox">
                            <input type="checkbox" id="printerEnabled" checked>
                            <label for="printerEnabled">Printer Enabled</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancelBtn">Cancel</button>
                <button class="btn-primary" id="savePrinterBtn">Save Printer</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmationModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Confirm Action</div>
                <button class="modal-close" id="closeConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="confirmation-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="confirmation-text" id="confirmText">
                    Are you sure you want to delete this printer? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="cancelConfirmBtn">Cancel</button>
                    <button class="btn-primary" id="confirmActionBtn" style="background-color: #e74c3c;">Delete Printer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const AUTH = {
            "x-client-id": "clt-admin",
            "x-print-key": "123456"
        };
        
        let printersData = {
            printers: []
        };
        
        let currentAction = null;
        let printerToDelete = null;
        
        // DOMContentLoaded event
        document.addEventListener('DOMContentLoaded', function() {
            loadPrintersData();
            
            // Add event listeners
            document.getElementById('refreshBtn').addEventListener('click', refreshPrinters);
            document.getElementById('addPrinterBtn').addEventListener('click', openPrinterModal);
            document.getElementById('closeModal').addEventListener('click', closePrinterModal);
            document.getElementById('cancelBtn').addEventListener('click', closePrinterModal);
            document.getElementById('savePrinterBtn').addEventListener('click', savePrinter);
            
            document.getElementById('closeConfirmModal').addEventListener('click', closeConfirmationModal);
            document.getElementById('cancelConfirmBtn').addEventListener('click', closeConfirmationModal);
            document.getElementById('confirmActionBtn').addEventListener('click', executeConfirmedAction);
            
            // Close modals when clicking outside
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        if (this.id === 'printerModal') closePrinterModal();
                        if (this.id === 'confirmationModal') closeConfirmationModal();
                    }
                });
            });
        });
        
        // Fetch printers from API
        async function loadPrintersData() {
            try {
                const response = await fetch('/api/printers_app', {
                    headers: {
                        ...AUTH,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                printersData = data;
                renderPrinters();
            } catch (error) {
                console.error('Error loading printers:', error);
                showToast('Failed to load printers', 'error');
                
                // Show empty state
                const container = document.getElementById('printersContainer');
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Connection Error</h3>
                        <p>Unable to connect to the server. Please check your connection.</p>
                        <p><button class="action-btn refresh" style="margin-top: 20px;" onclick="loadPrintersData()">
                            <i class="fas fa-redo"></i> Retry
                        </button></p>
                    </div>
                `;
            }
        }
        
        // Render printers in the UI
        function renderPrinters() {
            const container = document.getElementById('printersContainer');
            const statusText = document.getElementById('statusText');
            
            if (!printersData || !printersData.printers || printersData.printers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-print"></i>
                        <h3>No Printers Found</h3>
                        <p>No printers are currently registered in the system.</p>
                        <p><button class="action-btn add" style="margin-top: 20px;" id="addFirstPrinterBtn">
                            <i class="fas fa-plus"></i> Add Your First Printer
                        </button></p>
                    </div>
                `;
                
                document.getElementById('addFirstPrinterBtn').addEventListener('click', openPrinterModal);
                statusText.innerHTML = `<i class="fas fa-circle"></i><span>0 Printers</span>`;
                return;
            }
            
            // Update status badge
            const onlineCount = printersData.printers.filter(p => p.online).length;
            const enabledCount = printersData.printers.filter(p => p.enabled).length;
            statusText.innerHTML = `<i class="fas fa-circle"></i><span>${onlineCount}/${printersData.printers.length} Online • ${enabledCount} Enabled</span>`;
            
            // Generate printer cards
            let printersHTML = '';
            
            printersData.printers.forEach(printer => {
                const statusClass = printer.online ? '' : 'offline';
                const connectionStatus = printer.online ? 'Online' : 'Offline';
                
                // Generate settings badges
                let settingsHTML = '';
                if (printer.printSettings) {
                    if (printer.printSettings.cut) {
                        settingsHTML += `<span class="setting-badge"><i class="fas fa-cut"></i> Auto Cut</span>`;
                    }
                    if (printer.printSettings.doubleWidth) {
                        settingsHTML += `<span class="setting-badge"><i class="fas fa-arrows-alt-h"></i> Double Width</span>`;
                    }
                    if (printer.printSettings.bold) {
                        settingsHTML += `<span class="setting-badge"><i class="fas fa-bold"></i> Bold Text</span>`;
                    }
                }
                
                // Paper info
                const paperName = printer.paper?.name || 'RECEIPT(72mm)';
                const paperWidth = printer.paper?.width || 576;
                
                printersHTML += `
                    <div class="printer-card" id="printer-${printer.id}">
                        <div class="printer-header">
                            <div class="printer-name-container">
                                <div class="printer-icon">
                                    <i class="fas fa-receipt"></i>
                                </div>
                                <div>
                                    <div class="printer-name">${printer.name}</div>
                                    <div class="printer-id">ID: ${printer.id}</div>
                                </div>
                            </div>
                            <div class="printer-role ${printer.role === 'ADMIN' ? 'admin' : ''}">${printer.role}</div>
                        </div>
                        
                        <div class="printer-details">
                            <div class="detail-row">
                                <div class="detail-label">
                                    <i class="fas fa-power-off"></i>
                                    Status
                                </div>
                                <div class="detail-value">
                                    <div class="connection-info">
                                        <span class="connection-dot ${statusClass}"></span>
                                        <span>${connectionStatus}</span>
                                        ${!printer.enabled ? '<span style="color:#e74c3c; margin-left: 10px;">(Disabled)</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">
                                    <i class="fas fa-network-wired"></i>
                                    Connection
                                </div>
                                <div class="detail-value">${printer.connection?.ip || 'N/A'}:${printer.connection?.port || 'N/A'}</div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">
                                    <i class="fas fa-paperclip"></i>
                                    Paper Type
                                </div>
                                <div class="detail-value">
                                    <div class="paper-info">
                                        <span>${paperName}</span>
                                        <span class="paper-width">${paperWidth}px</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="detail-row">
                                <div class="detail-label">
                                    <i class="fas fa-cog"></i>
                                    Settings
                                </div>
                                <div class="detail-value">
                                    <div class="settings-info">
                                        ${settingsHTML || '<span style="color:#95a5a6">No special settings</span>'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="printer-actions">
                            <button class="btn btn-edit" onclick="editPrinter('${printer.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-test" onclick="testPrinter('${printer.id}')" ${!printer.enabled ? 'disabled' : ''}>
                                <i class="fas fa-print"></i> Test Print
                            </button>
                            <button class="btn btn-toggle" onclick="togglePrinter('${printer.id}', ${printer.enabled})">
                                <i class="fas fa-power-off"></i> ${printer.enabled ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn btn-delete" onclick="deletePrinter('${printer.id}', '${printer.name}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = printersHTML;
        }
        
        // Modal functions
        function openPrinterModal(printerId = null) {
            const modal = document.getElementById('printerModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('printerForm');
            
            if (printerId) {
                // Edit mode
                title.textContent = 'Edit Printer';
                const printer = printersData.printers.find(p => p.id === printerId);
                
                if (printer) {
                    document.getElementById('printerId').value = printer.id;
                    document.getElementById('printerName').value = printer.name;
                    document.getElementById('printerRole').value = printer.role;
                    document.getElementById('printerIp').value = printer.connection?.ip || '';
                    document.getElementById('printerPort').value = printer.connection?.port || 9100;
                    document.getElementById('paperName').value = printer.paper?.name || 'RECEIPT(72mm)';
                    document.getElementById('paperWidth').value = printer.paper?.width || 576;
                    document.getElementById('cutPaper').checked = printer.printSettings?.cut || false;
                    document.getElementById('printerEnabled').checked = printer.enabled || true;
                }
            } else {
                // Add mode
                title.textContent = 'Add Printer';
                form.reset();
                document.getElementById('printerId').value = '';
                document.getElementById('printerName').value = '';
                document.getElementById('printerRole').value = 'CASHIER';
                document.getElementById('printerIp').value = '';
                document.getElementById('printerPort').value = '9100';
                document.getElementById('paperName').value = 'RECEIPT(72mm)';
                document.getElementById('paperWidth').value = '576';
                document.getElementById('cutPaper').checked = true;
                document.getElementById('printerEnabled').checked = true;
            }
            
            modal.style.display = 'flex';
        }
        
        function closePrinterModal() {
            document.getElementById('printerModal').style.display = 'none';
        }
        
        // Edit printer
        function editPrinter(printerId) {
            openPrinterModal(printerId);
        }
        
        // Save printer (add or update) - using your /api/printer/save endpoint
        async function savePrinter() {
            const idField = document.getElementById('printerId');
            const name = document.getElementById('printerName').value;
            const role = document.getElementById('printerRole').value;
            const ip = document.getElementById('printerIp').value;
            const port = document.getElementById('printerPort').value;
            const paperName = document.getElementById('paperName').value;
            const paperWidth = document.getElementById('paperWidth').value;
            const cutPaper = document.getElementById('cutPaper').checked;
            const enabled = document.getElementById('printerEnabled').checked;
            
            // Validate IP address
            const ipPattern = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
            if (!ipPattern.test(ip)) {
                showToast('Please enter a valid IP address', 'error');
                return;
            }
            
            // Validate port
            const portNum = parseInt(port);
            if (portNum < 1 || portNum > 65535) {
                showToast('Please enter a valid port (1-65535)', 'error');
                return;
            }
            
            const printerData = {
                id: idField.value || generatePrinterId(name),
                name: name,
                role: role,
                enabled: enabled,
                connection: {
                    ip: ip,
                    port: portNum
                },
                paper: {
                    name: paperName,
                    width: parseInt(paperWidth)
                },
                printSettings: {
                    cut: cutPaper
                }
            };
            
            try {
                showToast('Saving printer...', 'success');
                
                // Call your actual API endpoint
                const response = await fetch('/api/printer/save', {
                    method: 'POST',
                    headers: {
                        ...AUTH,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(printerData)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showToast('Printer saved successfully', 'success');
                        closePrinterModal();
                        refreshPrinters();
                    } else {
                        showToast(data.error || 'Failed to save printer', 'error');
                    }
                } else {
                    const error = await response.json();
                    showToast(error.error || 'Failed to save printer', 'error');
                }
                
            } catch (error) {
                console.error('Error saving printer:', error);
                showToast('Failed to save printer: ' + error.message, 'error');
            }
        }
        
        // Generate printer ID from name
        function generatePrinterId(name) {
            return name.toLowerCase()
                .replace(/[^a-z0-9]/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '') + '-' + Date.now().toString().slice(-6);
        }
        
        // Test printer - using your /api/printer/test endpoint
        async function testPrinter(printerId) {
            try {
                showToast('Sending test print...', 'success');
                
                const response = await fetch('/api/printer/test', {
                    method: 'POST',
                    headers: {
                        ...AUTH,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ printerId: printerId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.printed) {
                        showToast('Test print sent successfully', 'success');
                    } else {
                        showToast(data.error || 'Test print failed', 'error');
                    }
                } else {
                    showToast(data.error || 'Test print failed', 'error');
                }
                
                // Refresh printer status after test
                setTimeout(() => {
                    refreshPrinters();
                }, 1000);
                
            } catch (error) {
                console.error('Error testing printer:', error);
                showToast('Failed to send test print', 'error');
            }
        }
        
        // Toggle printer enabled/disabled - using the same save API
        async function togglePrinter(printerId, currentStatus) {
            try {
                const printer = printersData.printers.find(p => p.id === printerId);
                if (!printer) {
                    showToast('Printer not found', 'error');
                    return;
                }
                
                // Toggle the enabled status
                printer.enabled = !currentStatus;
                
                // Save the updated printer using the save API
                const response = await fetch('/api/printer/save', {
                    method: 'POST',
                    headers: {
                        ...AUTH,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(printer)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        showToast(`Printer ${currentStatus ? 'disabled' : 'enabled'} successfully`, 'success');
                        refreshPrinters();
                    } else {
                        showToast(data.error || 'Failed to update printer', 'error');
                    }
                } else {
                    showToast('Failed to update printer', 'error');
                }
                
            } catch (error) {
                console.error('Error toggling printer:', error);
                showToast('Failed to toggle printer', 'error');
            }
        }
        
        // Delete printer - using your /api/printer/delete endpoint
        function deletePrinter(printerId, printerName) {
            printerToDelete = printerId;
            document.getElementById('confirmText').textContent = `Are you sure you want to delete "${printerName}"? This action cannot be undone.`;
            document.getElementById('confirmActionBtn').innerHTML = '<i class="fas fa-trash"></i> Delete Printer';
            document.getElementById('confirmActionBtn').style.backgroundColor = '#e74c3c';
            
            currentAction = 'delete';
            document.getElementById('confirmationModal').style.display = 'flex';
        }
        
        // Close confirmation modal
        function closeConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
            printerToDelete = null;
        }
        
        // Execute confirmed action (delete) - using your /api/printer/delete endpoint
        async function executeConfirmedAction() {
            if (currentAction === 'delete' && printerToDelete) {
                try {
                    showToast('Deleting printer...', 'success');
                    
                    const response = await fetch('/api/printer/delete', {
                        method: 'POST',
                        headers: {
                            ...AUTH,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: printerToDelete })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showToast('Printer deleted successfully', 'success');
                        closeConfirmationModal();
                        refreshPrinters();
                    } else {
                        showToast(data.error || 'Failed to delete printer', 'error');
                        closeConfirmationModal();
                    }
                    
                } catch (error) {
                    console.error('Error deleting printer:', error);
                    showToast('Failed to delete printer', 'error');
                    closeConfirmationModal();
                }
            }
        }
        
        // Refresh printers
        async function refreshPrinters() {
            const container = document.getElementById('printersContainer');
            const refreshBtn = document.getElementById('refreshBtn');
            
            // Show loading state
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Refreshing printer data...</p>
                </div>
            `;
            
            // Disable refresh button during load
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing';
            
            try {
                await loadPrintersData();
                showToast('Printer list refreshed', 'success');
            } catch (error) {
                showToast('Failed to refresh printers', 'error');
            } finally {
                // Re-enable refresh button
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(-50%) translateY(20px)';
                    setTimeout(() => {
                        if (toast.parentNode) toast.parentNode.removeChild(toast);
                    }, 300);
                }
            }, 3000);
        }
    </script>
</body>
</html>
